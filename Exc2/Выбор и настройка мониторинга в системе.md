# Выбор и настройка мониторинга в системе

## Мотивация

На данном этапе развития приложения становиться недостаточным то количество метрик, которое предоставляет нам провайдер облака. Текущее плачевное состояние системы во многом стало следствием недостаточности информации о состоянии системных компонент, отсутствие алертинга о критических проблемах, ошибках и перегрузках. Внедрение мониторинга позволит не только качественно проработать слабые места системы, но и позволит избежать таких проблем в дальнейшем, а также уменьшит временные затраты на поиск и исправление потенциальных ошибок. Также мониторинг поможет собирать бизнес метрики приложения, которые позволят оценивать возможные перспективы развития и оптимизации бизнес процессов.

## Выбор подхода к мониторингу

### Системные метрики

Будем считать, что на данном этапе у нас уже существует базовые мониторинг показателей системного уровня. В нашем случае эти данные не дадут нам какой-то дополнительной информации, но они важны для оценки загруженности железа и принятии решения о вертикальном или горизонтальном масштабировании. 

### Метрики производительности

Самым высоконагруженным сервисом системы является MES. Он занимается сложными вычислениями (расчет стоимости), а также взаимодействием с исполнителями заказов. Для него рациональнее всего будет использовать USE, так как нам важно понимать, какое количество времени система загружена вычислениям и есть ли очередь задач на вычисление. Эти параметры помогут понять, что сервис в текущем состоянии не справляется с нагрузкой, что в дальнейшем отражается на всех пользователях.

При этом для части MES, с которой взаимодействуют исполнители заказов, лучше использовать "Четыре золотых сигнала". Так как важно, чтобы исполнители могли оперативно получать информацию о заказах. Также необходимо отслеживать RPS сервисов, для анализа и характера нагрузки.

Для CRM и Shop будет достаточно RED, чтобы понимать достаточно ли отзывчива система, чтобы не доставлять неудобство пользователям.

### Бизнес метрики

Как бизнес метрику можно предложить отслеживание времени между статусами заказа. Это позволит понимать, в чем именно заключается причина, по которой пользователь не получил заказ вовремя. Это позволит адаптировать бизнес с учетом новых потребностей (увеличить штат администраторов или расширить производственные мощности).

## Конкретный выбор метрик

* Number of `dead-letter-exchange` letters in RabbitMQ (критический)
  * Поможет понять, когда система перегружена и сообщения копятся в очереди
* Number of message `in flight` in RabbitMQ
  * Общая активность системы
* Number of requests (RPS) for internet shop API
  * Нагрузка на сервис магазина, активность пользователей
* Number of requests (RPS) for MES API (критический)
  * Активность изготовителей
* Number of requests (RPS) for CRM API
  * Активность в CRM (для общей картины)
* Number of requests (RPS) per user for internet shop API
  * Поможет оценить эффективность кэша, а также вычислить злоумышленников
* CPU % for MES API
  * Справляется ли железо с нагрузкой
* CPU % for CRM API
* CPU % for Shop API
* Response time (latency) for MES API
  * Удовлетворенность изготовителей, увеличит скорость от заказа до начала изготовления
* Response time (latency) for shop API
  * Удовлетворенность пользователей
* Size of S3 storage
  * Большой объем файлов, отслеживание исключит неожиданное переполнение
* Number of `HTTP 500` for MES API (критический)
  * Возможная потеря данных и простой на производстве
* Number of `HTTP 500` for shop API (критический)
  * Возможное разочарование пользователей и потеря клиентов
* Memory Utilisation
* Number of connections for databases
* Number of simultanious sessions for API

## План действий

1) Развернуть инстанс InfluxDB
2) Установить и настроить Prometheus
3) Настроить мониторинг сервисов по push модели
4) Настройка мониторинга s3, баз данных и очередей сообщений
5) Установка и настройка Grafana
6) Создание dashboards и алертов в Grafana